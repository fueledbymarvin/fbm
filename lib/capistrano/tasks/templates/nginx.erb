upstream puma {
  server              unix:///tmp/puma.<%= fetch(:application) %>/sock fail_timeout=0;
}

server {
  listen              80 default deferred;

  location ^~ /assets/ {
    gzip_static	      on;
    expires	      max;
    add_header	      Cache-Control public;
  }

  location / {
    root              <%= fetch(:deploy_to) %>/public;
    try_files         $uri @puma;
    gzip_static       on;
    expires           max;
    add_header        Cache-Control public;
  }

  location @puma {
    proxy_pass        http://puma;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  X-Forwarded-Proto https;
    proxy_set_header  Host $http_host;
    proxy_redirect    off;
    proxy_next_upstream error timeout invalid_header http_502;
  }

  error_page 500 502 503 504 /500.html;
  client_max_body_size 4G;
  keepalive_timeout 10;
}